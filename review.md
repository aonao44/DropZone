http://localhost:3000/dashboard

## 実装完了事項

### ✅ プラン別の機能制限
- **フリープラン**: プロジェクト3件、ファイル5件まで
- **プレミアムプラン**: プロジェクト20件、ファイル50件まで
- 実装場所: `/components/DashboardClient.tsx:36-37`

### ✅ サブスクリプション状態の自動判定
- Clerk Billingの複数の方法でサブスクリプション状態を確認
- 実装場所: `/app/dashboard/page.tsx:20-37`

### ✅ 条件付きUIの表示
- フリープラン時: 「プレミアムにアップグレード」ボタンを表示
- プレミアムプラン時: ボタンを非表示
- 実装場所: `/components/DashboardClient.tsx:124-130`

## よくある質問

### Q1: アカウントごとにダッシュボードが分かれていない？
**A:** 修正しました！各ユーザーは自分のプロジェクトのみ閲覧・操作可能です。

#### 実装した修正内容：
1. **プロジェクト作成時にuser_idを保存** (`/app/api/projects/route.ts:10-42`)
   - ClerkのユーザーIDを`user_id`カラムに保存
   - 認証チェックを追加

2. **ダッシュボードでログインユーザーのプロジェクトのみ取得** (`/app/dashboard/page.tsx:53-64`)
   - `.eq("user_id", userId)` でフィルタリング
   - 他のユーザーのプロジェクトは表示されない

3. **プロジェクト削除時に所有者チェック** (`/app/api/projects/[id]/route.ts:35-40`)
   - `.eq("user_id", userId)` で所有者のみ削除可能
   - 他人のプロジェクトは削除不可

4. **プロジェクト閲覧時に所有者チェック** (`/app/project/[slug]/view/page.tsx:43-57`)
   - 所有者以外がアクセスした場合は404エラー
   - URLを知っていても他人のプロジェクトは閲覧不可

#### セキュリティの仕組み：
- 各プロジェクトには作成者の`user_id`（ClerkのユーザーID）が保存されます
- ダッシュボード、削除、閲覧の全操作で`user_id`による所有者チェックを実施
- 別のアカウントでログインすると、そのユーザーのプロジェクトのみが表示されます

### Q2: フリープランと有料プランの切り替え方法は？
**A:** ユーザーは以下の2つの方法でサブスクリプションを管理できます：

#### 方法1: UserButton から管理（推奨）
1. ダッシュボード右上の**アバターアイコン**をクリック
2. 「Billing」タブを選択
3. 以下の操作が可能：
   - サブスクリプションの確認
   - プランのキャンセル/アップグレード
   - 請求履歴の確認
   - 支払い方法の変更

#### 方法2: Clerk Dashboard から管理（開発者/管理者向け）
1. [Clerk Dashboard](https://dashboard.clerk.com) にアクセス
2. 「Subscriptions」タブに移動
3. ユーザーを検索してサブスクリプションを管理
4. 2つのオプション：
   - **Cancel**: 次回請求を停止、現在の期間終了まで有効
   - **End**: 即座にサブスクリプションを終了

#### テスト用の切り替え手順
1. プレミアム→フリー: UserButtonから「Cancel」または「End」
2. フリー→プレミアム: 「プレミアムにアップグレード」ボタンからClerkの決済フロー
3. 変更後、ページをリロードして状態を確認

## テスト済み動作
- ✅ プレミアムプラン: アップグレードボタン非表示
- ✅ フリープラン: アップグレードボタン表示
- ✅ サブスクリプション状態の自動検出
- ✅ プラン別の制限値設定
- ✅ ユーザー別のプロジェクト分離（2025-11-12修正完了）
- ✅ データベースマイグレーション完了（UUID→TEXT型変換）

## 最新の修正（2025-11-12）

### 🔧 データベーススキーマ修正
**問題**: `projects.user_id`カラムがUUID型で、ClerkのユーザーID（TEXT型）を保存できずエラー発生

**エラーコード**: `22P02 - invalid input syntax for type uuid`

**実施したマイグレーション**:
```sql
-- マイグレーション: change_user_id_to_text_remove_all_policies
1. RLSポリシーを削除（auth.uid()ベースのポリシーはClerk認証では機能しない）
2. projects.user_id カラムをUUID型からTEXT型に変更
3. インデックスを再作成
```

**マイグレーションファイル**: `/supabase/migrations/003_change_user_id_to_text.sql`

**実行方法**: Supabase Management API経由で直接適用済み

### ✅ 動作確認（Playwright使用）
1. ダッシュボードアクセス: エラーなし
2. 新規プロジェクト作成: `user_id`が正しく保存される（例: `user_35KJ29g1gUm4bkMq1qh1viYr1Hd`）
3. プロジェクト一覧: ログインユーザーのプロジェクトのみ表示
4. プロジェクト詳細: 所有者のみアクセス可能

### 📝 重要な変更点
- **RLSポリシー**: Supabase Auth（`auth.uid()`）ベースのポリシーを削除
- **セキュリティ**: アプリケーションレイヤー（Clerk認証）でアクセス制御を実装
- **既存データ**: 旧プロジェクト（`user_id`がNULL）は表示されないが、データは保持
